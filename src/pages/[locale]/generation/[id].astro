---
export const prerender = true

import Layout from '@/layouts/Layout.astro'
import { GenerationInfiniteScrollWrapper } from '@/components/GenerationInfiniteScrollWrapper'
import type { Pokemon, PokemonList } from '@/utils/pokemon'
import { getI18n, locales } from '@/utils/i18n'

export function getStaticPaths() {
  // Generation data - must be inside getStaticPaths for Astro to access it
  const generations = [
    { id: 1, nameEn: 'Generation I', nameEs: 'Generación I', region: 'Kanto' },
    { id: 2, nameEn: 'Generation II', nameEs: 'Generación II', region: 'Johto' },
    { id: 3, nameEn: 'Generation III', nameEs: 'Generación III', region: 'Hoenn' },
    { id: 4, nameEn: 'Generation IV', nameEs: 'Generación IV', region: 'Sinnoh' },
    { id: 5, nameEn: 'Generation V', nameEs: 'Generación V', region: 'Unova' },
    { id: 6, nameEn: 'Generation VI', nameEs: 'Generación VI', region: 'Kalos' },
    { id: 7, nameEn: 'Generation VII', nameEs: 'Generación VII', region: 'Alola' },
    { id: 8, nameEn: 'Generation VIII', nameEs: 'Generación VIII', region: 'Galar' },
    { id: 9, nameEn: 'Generation IX', nameEs: 'Generación IX', region: 'Paldea' },
  ]

  const paths = []
  for (const locale of locales) {
    for (const gen of generations) {
      paths.push({
        params: { locale, id: String(gen.id) },
        props: { generationData: gen },
      })
    }
  }
  return paths
}

const { locale: localeParam } = Astro.params
const { generationData } = Astro.props
const { locale, t } = getI18n(localeParam)

const generation = {
  id: generationData.id,
  name: locale === 'es' ? generationData.nameEs : generationData.nameEn,
  region: generationData.region,
}

// Generation color mapping
const genColors: Record<number, string> = {
  1: 'from-red-600 to-blue-600',
  2: 'from-yellow-500 to-purple-600',
  3: 'from-blue-600 to-green-600',
  4: 'from-purple-600 to-pink-600',
  5: 'from-gray-700 to-blue-700',
  6: 'from-pink-500 to-blue-500',
  7: 'from-orange-500 to-blue-600',
  8: 'from-cyan-600 to-purple-700',
  9: 'from-red-600 to-purple-600',
}

const gradientClass = genColors[generation.id] || 'from-gray-400 to-gray-500'

// Fetch generation data from PokéAPI
const genRes = await fetch(`https://pokeapi.co/api/v2/generation/${generation.id}`)
if (!genRes.ok) {
  return Astro.redirect(`/${locale}/404`)
}
const genData = await genRes.json()

// Get first page of pokemon (30 items)
const pageSize = 30
const speciesSlice = genData.pokemon_species.slice(0, pageSize)

// Fetch full details for first page
const pokemonPromises = speciesSlice.map(async (species: { name: string }) => {
  const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${species.name}`)
  if (!res.ok) return null
  return res.json()
})

const resultsWithNull = await Promise.all(pokemonPromises)
const results: Pokemon[] = resultsWithNull.filter((p): p is Pokemon => p !== null)

// Sort by order number
results.sort((a, b) => a.order - b.order)

const initialData: PokemonList = {
  count: genData.pokemon_species.length,
  results,
}
---

<Layout title={`${generation.name} - ${generation.region} ${t.pages.region}`} locale={locale}>
  <GenerationInfiniteScrollWrapper
    client:load
    initialData={initialData}
    generation={generation}
    generationColor={gradientClass}
    locale={locale}
  />
</Layout>
