---
export const prerender = true

import Layout from '@/layouts/Layout.astro'
import { PokemonTile } from '@/components/PokemonTile'
import type { Pokemon } from '@/utils/pokemon'

export async function getStaticPaths() {
  // Generation data
  const generations = [
    { id: 1, name: 'Generation I', region: 'Kanto', range: [1, 151] },
    { id: 2, name: 'Generation II', region: 'Johto', range: [152, 251] },
    { id: 3, name: 'Generation III', region: 'Hoenn', range: [252, 386] },
    { id: 4, name: 'Generation IV', region: 'Sinnoh', range: [387, 493] },
    { id: 5, name: 'Generation V', region: 'Unova', range: [494, 649] },
    { id: 6, name: 'Generation VI', region: 'Kalos', range: [650, 721] },
    { id: 7, name: 'Generation VII', region: 'Alola', range: [722, 809] },
    { id: 8, name: 'Generation VIII', region: 'Galar', range: [810, 905] },
    { id: 9, name: 'Generation IX', region: 'Paldea', range: [906, 1025] },
  ]

  return generations.map((gen) => ({
    params: { id: String(gen.id) },
    props: { generation: gen },
  }))
}

const { generation } = Astro.props
const [start, end] = generation.range

// Fetch Pokémon for this generation using the generation endpoint
const genRes = await fetch(`https://pokeapi.co/api/v2/generation/${generation.id}`)
if (!genRes.ok) {
  return Astro.redirect('/404')
}
const genData = await genRes.json()

// Fetch full details for each Pokémon species
const pokemonPromises = genData.pokemon_species.map(async (species: { name: string; url: string }) => {
  const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${species.name}`)
  if (!res.ok) return null
  return res.json()
})

const allPokemonResults = await Promise.all(pokemonPromises)
const allPokemon: Pokemon[] = allPokemonResults.filter((p): p is Pokemon => p !== null)

// Sort by order number
const sortedPokemon = allPokemon.sort((a, b) => a.order - b.order)

// Generation color mapping
const genColors: Record<number, string> = {
  1: 'from-red-600 to-blue-600',
  2: 'from-yellow-500 to-purple-600',
  3: 'from-blue-600 to-green-600',
  4: 'from-purple-600 to-pink-600',
  5: 'from-gray-700 to-blue-700',
  6: 'from-pink-500 to-blue-500',
  7: 'from-orange-500 to-blue-600',
  8: 'from-cyan-600 to-purple-700',
  9: 'from-red-600 to-purple-600',
}

const gradientClass = genColors[generation.id] || 'from-gray-400 to-gray-500'
---

<Layout title={`${generation.name} - ${generation.region} Region Pokémon`}>
  <div class="space-y-8">
    <!-- Header -->
    <div class={`bg-gradient-to-r ${gradientClass} rounded-2xl p-8 md:p-12 text-center shadow-xl`}>
      <h1 class="text-4xl md:text-6xl font-bold text-white mb-2">
        {generation.name}
      </h1>
      <p class="text-2xl md:text-3xl text-white/90 mb-4">
        {generation.region} Region
      </p>
      <p class="text-lg md:text-xl text-white/80">
        {sortedPokemon.length} Pokémon species
      </p>
    </div>

    <!-- Back Link -->
    <div>
      <a
        href="/"
        class="inline-flex items-center gap-2 text-primary hover:text-primary-600 dark:text-primary-300 dark:hover:text-primary-400 transition-colors font-semibold"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Home
      </a>
    </div>

    <!-- Pokémon Grid -->
    <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5">
      {sortedPokemon.map((pokemon) => (
        <PokemonTile pokemon={pokemon} client:idle />
      ))}
    </div>
  </div>
</Layout>
